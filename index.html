<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Battery demand and mineral supply model</title>
  <style>
    :root {
      /* Original theme variables */
      --slate-blue: #192238;
      --off-white: #eceff5;
      --white: #fff;
      --mid-slate-blue: #414f6f;
      --jet-black: #000;
      --ember-green: #13ce74;
      --light-ember-green: #1de987;
      --grey-blue: #d6dbe9;
      --dark-grey: #959aa7;
      --dark-grey-blue: #626e88;
      --transparent: #fff0;
      --ash-blue: #dee6ef;
      /* New theme variables from provided code */
      --color_theme_bg_pop: #13ce74;
      --background_pop: #13ce74;
      --color_theme_bg_web: #ffffff;
      --cover_bg_color: #ffffff;
      --background_pop_darken: #11b767;
      --print_on_pop: #ffffff;
      --color_theme_bg_pop_darken: #11b767;
      --color_theme_print_on_pop: #ffffff;
      --border_subtle: rgba(204, 204, 204, 0.5);
      --background_subtle: rgba(220, 248, 234, 0.4);
      --print_pop: #13ce74;
      --color_theme_accent: #13ce74;
      --cover_print_primary: #363737;
      --cover_print_secondary: #757575;
      --cover_print_tertiary: #b6b6b6;
      --cover_border_color: #13ce74;
      --font_family_body_preset: 'SF Pro Display', -apple-system, system-ui, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
      --font_weight_body_preset: 400;
      --font_preset_body: sans;
      --web_bg_color: #ffffff;
      --background_contrast_1: #f0f0f0;
      --color_theme_bg_contrast_1: #f0f0f0;
      --background_contrast_2: #dddddd;
      --color_theme_bg_contrast_2: #dddddd;
      --background_contrast_3: #b7b7b7;
      --color_theme_bg_contrast_3: #b7b7b7;
      --background_contrast_4: #929292;
      --color_theme_bg_contrast_4: #929292;
      --background_contrast_5: #515151;
      --color_theme_bg_contrast_5: #515151;
      --color_theme_detail: #e6e6e6;
      --background_contrast_pop: rgba(19, 206, 116, 0.4);
      --color_theme_bg_contrast_pop: rgba(19, 206, 116, 0.4);
      --input_background: #ffffff;
      --cover_input_background: #ffffff;
      --tooltip_background: #191919;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      background: #f7f7f7; /* VERY LIGHT gray background */
      color: var(--slate-blue);
      font-family: Poppins, sans-serif;
      font-size: 15px;
      line-height: 23px;
      margin: 0;
    }
    header.container {
      padding-bottom: 0.5rem;
      background: var(--white);
      border-bottom: 1px solid var(--grey-blue);
      margin-bottom: 1rem;
    }
    header.container h1 {
      margin: 20px 0;
      font-size: 3.2em;
      font-weight: 500;
      line-height: 1.2em;
      position: relative;
    }
    header.container h1::before {
      content: "";
      display: inline-block;
      width: 6px;
      height: 1em;
      background: var(--color_theme_accent);
      margin-right: 10px;
      vertical-align: middle;
    }
    header.container p.disclaimer {
      font-size: 0.9em;
      color: var(--dark-grey);
      margin: 0 0 1rem 0;
    }
    h2 {
      margin: 20px 0;
      font-size: 2.5em;
      font-weight: 500;
      line-height: 1.2em;
    }
    /* Title above sidebar groups */
    #sidebar h2 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.8em;
      font-weight: 500;
      border-bottom: 1px solid var(--grey-blue);
      padding-bottom: 0.5rem;
    }
    /* Group titles (majors) styling without boxes, with toggle arrow and extra spacing */
    .group-title {
      margin: 15px 0 10px 0;
      font-size: 1.5em;
      font-weight: 500;
      cursor: pointer;
    }
    .group-title::before {
      content: "";
      display: inline-block;
      width: 6px;
      height: 1.2em;
      background: var(--color_theme_accent);
      margin-right: 8px;
      vertical-align: middle;
    }
    .group-title::after {
      content: "►";
      float: right;
      font-size: 0.8em;
      vertical-align: middle;
    }
    .group-title.expanded::after {
      content: "▼";
    }
    /* Default state: groups collapsed, plain grouping without grey background */
    .group .group-content { 
      display: none;
      margin-top: 10px;
      margin-bottom: 20px;
      /* Removed grey background and border styling */
      padding-left: 0;
    }
    .group {
      margin-bottom: 20px;
    }
    fieldset {
      margin-bottom: 20px;
    }
    fieldset legend {
      border-left: 4px solid var(--color_theme_accent);
      padding-left: 8px;
      font-size: 1.1em;
      margin-bottom: 10px;
    }
    fieldset label {
      border-left: 2px solid var(--grey-blue);
      padding-left: 5px;
      margin-bottom: 5px;
      display: block;
      font-weight: 600;
    }
    input[type="number"],
    select {
      width: 100%;
      padding: 0.4rem;
      border: 1px solid var(--grey-blue);
      border-radius: 4px;
      font-size: 0.95rem;
      background: var(--white);
      color: var(--slate-blue);
    }
    .container {
      width: 100%;
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      background: var(--white);
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .sim-container {
      display: flex;
      height: calc(100vh - 150px);
      gap: 20px;
    }
    /* Sidebar styling */
    #sidebar {
      width: 320px;
      background: var(--white);
      padding: 1rem;
      padding-bottom: 30px;
      border: 1px solid var(--grey-blue);
      border-right: none;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      overflow-y: auto;
    }
    /* Content area (chart + controls) */
    #content {
      flex-grow: 1;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      border: 1px solid var(--grey-blue);
      border-radius: 8px;
    }
    #chartControls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 1rem;
    }
    #chartControls label {
      margin: 0;
      font-weight: 600;
      white-space: nowrap;
    }
    #chartControls select {
      min-width: 150px;
      padding: 0.4rem;
      border: 1px solid var(--grey-blue);
      border-radius: 4px;
      background: var(--white);
      color: var(--slate-blue);
    }
    #chartControls button {
      padding: 8px 15px;
      font-size: 0.9em;
      border: none;
      border-radius: 4px;
      background-color: var(--color_theme_bg_pop);
      color: var(--slate-blue);
      cursor: pointer;
      transition: background-color 0.2s;
    }
    #chartControls button:hover {
      background-color: var(--background_pop_darken);
    }
    #chartSection {
      flex-grow: 1;
      min-height: 600px;
    }
    @media screen and (max-width: 767px) {
      .sim-container { flex-direction: column; height: auto; }
      #sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--grey-blue);
      }
    }
    /* Footer banner */
    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: var(--white);
      border-top: 1px solid #000;
      text-align: center;
      padding: 5px;
      font-size: 0.8em;
      color: var(--dark-grey);
    }
    footer strong {
      font-weight: bold;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/scale.css"/>
  <script>
    // Set Chart.js default font family and size.
    Chart.defaults.font.family = 'Poppins, sans-serif';
    Chart.defaults.font.size = 15;
  </script>
</head>
<body>
  <header class="container">
    <h1>Battery demand and mineral supply model</h1>
    <p class="disclaimer">
      This is a high level model made with AI, based on the public RMI report that can be found 
      <a href="https://rmi.org/insight/the-battery-mineral-loop/" target="_blank">here</a>.
      Note: The numbers and outlooks in this model are generated by an AI model and are for directional insights only; they should not be taken as precise forecasts.
    </p>
  </header>
  <div class="container sim-container">
    <!-- Sidebar with simulation parameters -->
    <div id="sidebar">
      <h2>Model parameters</h2>
      <!-- General Simulation Group -->
      <div class="group">
        <h3 class="group-title collapsed" onclick="toggleGroup(this)">General Simulation</h3>
        <div class="group-content">
          <fieldset>
            <legend>General</legend>
            <label for="startYear" data-tippy-content="The first year of simulation.">Start year:</label>
            <input type="number" id="startYear" value="2020" step="1">
            <label for="endYear" data-tippy-content="The last year of simulation.">End year:</label>
            <input type="number" id="endYear" value="2050" step="1">
          </fieldset>
        </div>
      </div>
      <!-- Battery Demand Group -->
      <div class="group">
        <h3 class="group-title collapsed" onclick="toggleGroup(this)">Battery Demand</h3>
        <div class="group-content">
          <fieldset>
            <legend>Cars</legend>
            <label for="carsL" data-tippy-content="The terminal annual battery demand for cars (in TWh/year).">Terminal demand (TWh/year):</label>
            <input type="number" id="carsL" value="8" step="0.1">
            <label for="carsK" data-tippy-content="The growth rate (k) in the s-curve for cars.">Growth rate (k):</label>
            <input type="number" id="carsK" value="0.4" step="0.1">
            <label for="carsT0" data-tippy-content="The inflection year (t₀) of the s-curve for cars.">Inflection year (t₀):</label>
            <input type="number" id="carsT0" value="2030" step="1">
          </fieldset>
          <fieldset>
            <legend>Light Trucks</legend>
            <label for="ltL" data-tippy-content="The terminal annual battery demand for light trucks (in TWh/year).">Terminal demand (TWh/year):</label>
            <input type="number" id="ltL" value="1.2" step="0.1">
            <label for="ltK" data-tippy-content="The growth rate (k) for light trucks.">Growth rate (k):</label>
            <input type="number" id="ltK" value="0.5" step="0.1">
            <label for="ltT0" data-tippy-content="The inflection year (t₀) for light trucks.">Inflection year (t₀):</label>
            <input type="number" id="ltT0" value="2029" step="1">
          </fieldset>
          <fieldset>
            <legend>Heavy Trucks</legend>
            <label for="htL" data-tippy-content="The terminal annual battery demand for heavy trucks (in TWh/year).">Terminal demand (TWh/year):</label>
            <input type="number" id="htL" value="2.0" step="0.1">
            <label for="htK" data-tippy-content="The growth rate (k) for heavy trucks.">Growth rate (k):</label>
            <input type="number" id="htK" value="0.4" step="0.1">
            <label for="htT0" data-tippy-content="The inflection year (t₀) for heavy trucks.">Inflection year (t₀):</label>
            <input type="number" id="htT0" value="2028" step="1">
          </fieldset>
          <fieldset>
            <legend>Stationary Storage</legend>
            <label for="ssL" data-tippy-content="The terminal annual battery demand for stationary storage (in TWh/year).">Terminal demand (TWh/year):</label>
            <input type="number" id="ssL" value="1.0" step="0.1">
            <label for="ssK" data-tippy-content="The growth rate (k) for stationary storage.">Growth rate (k):</label>
            <input type="number" id="ssK" value="0.3" step="0.1">
            <label for="ssT0" data-tippy-content="The inflection year (t₀) for stationary storage.">Inflection year (t₀):</label>
            <input type="number" id="ssT0" value="2030" step="1">
          </fieldset>
          <fieldset>
            <legend>Buses</legend>
            <label for="busesL" data-tippy-content="The terminal annual battery demand for buses (in TWh/year).">Terminal demand (TWh/year):</label>
            <input type="number" id="busesL" value="0.06" step="0.01">
            <label for="busesK" data-tippy-content="The growth rate (k) for buses.">Growth rate (k):</label>
            <input type="number" id="busesK" value="0.5" step="0.1">
            <label for="busesT0" data-tippy-content="The inflection year (t₀) for buses.">Inflection year (t₀):</label>
            <input type="number" id="busesT0" value="2028" step="1">
          </fieldset>
          <fieldset>
            <legend>2/3 Wheelers</legend>
            <label for="ttwL" data-tippy-content="The terminal annual battery demand for 2/3 wheelers (in TWh/year).">Terminal demand (TWh/year):</label>
            <input type="number" id="ttwL" value="0.3" step="0.01">
            <label for="ttwK" data-tippy-content="The growth rate (k) for 2/3 wheelers.">Growth rate (k):</label>
            <input type="number" id="ttwK" value="0.5" step="0.1">
            <label for="ttwT0" data-tippy-content="The inflection year (t₀) for 2/3 wheelers.">Inflection year (t₀):</label>
            <input type="number" id="ttwT0" value="2025" step="1">
          </fieldset>
          <fieldset>
            <legend>Trains</legend>
            <label for="trainsL" data-tippy-content="The terminal annual battery demand for trains (in TWh/year).">Terminal demand (TWh/year):</label>
            <input type="number" id="trainsL" value="0.12" step="0.01">
            <label for="trainsK" data-tippy-content="The growth rate (k) for trains.">Growth rate (k):</label>
            <input type="number" id="trainsK" value="0.3" step="0.1">
            <label for="trainsT0" data-tippy-content="The inflection year (t₀) for trains.">Inflection year (t₀):</label>
            <input type="number" id="trainsT0" value="2035" step="1">
          </fieldset>
          <fieldset>
            <legend>Ships</legend>
            <label for="shipsL" data-tippy-content="The terminal annual battery demand for ships (in TWh/year).">Terminal demand (TWh/year):</label>
            <input type="number" id="shipsL" value="0.12" step="0.01">
            <label for="shipsK" data-tippy-content="The growth rate (k) for ships.">Growth rate (k):</label>
            <input type="number" id="shipsK" value="0.3" step="0.1">
            <label for="shipsT0" data-tippy-content="The inflection year (t₀) for ships.">Inflection year (t₀):</label>
            <input type="number" id="shipsT0" value="2035" step="1">
          </fieldset>
          <fieldset>
            <legend>Airplanes</legend>
            <label for="planesL" data-tippy-content="The terminal annual battery demand for airplanes (in TWh/year).">Terminal demand (TWh/year):</label>
            <input type="number" id="planesL" value="0.12" step="0.01">
            <label for="planesK" data-tippy-content="The growth rate (k) for airplanes.">Growth rate (k):</label>
            <input type="number" id="planesK" value="0.3" step="0.1">
            <label for="planesT0" data-tippy-content="The inflection year (t₀) for airplanes.">Inflection year (t₀):</label>
            <input type="number" id="planesT0" value="2035" step="1">
          </fieldset>
        </div>
      </div>
      <!-- Battery Mineral Demand Group -->
      <div class="group">
        <h3 class="group-title collapsed" onclick="toggleGroup(this)">Battery Mineral Demand</h3>
        <div class="group-content">
          <fieldset data-tippy-content="Define the battery chemistry mix over time.">
            <legend>Battery Chemistry Mix</legend>
            <p>Start mix (%):</p>
            <label for="nmcStart" data-tippy-content="Percentage share of NMC batteries at start.">NMC:</label>
            <input type="number" id="nmcStart" value="55" step="1">
            <label for="lfpStart" data-tippy-content="Percentage share of LFP batteries at start.">LFP:</label>
            <input type="number" id="lfpStart" value="45" step="1">
            <label for="sodiumStart" data-tippy-content="Percentage share of Sodium batteries at start.">Sodium:</label>
            <input type="number" id="sodiumStart" value="0" step="1">
            <p>End mix (%):</p>
            <label for="nmcEnd" data-tippy-content="Percentage share of NMC batteries at end.">NMC:</label>
            <input type="number" id="nmcEnd" value="35" step="1">
            <label for="lfpEnd" data-tippy-content="Percentage share of LFP batteries at end.">LFP:</label>
            <input type="number" id="lfpEnd" value="55" step="1">
            <label for="sodiumEnd" data-tippy-content="Percentage share of Sodium batteries at end.">Sodium:</label>
            <input type="number" id="sodiumEnd" value="10" step="1">
            <label for="mineralDiscount" data-tippy-content="Reduction in mineral intensity per doubling of cumulative battery production.">Mineral intensity discount (% per doubling):</label>
            <input type="number" id="mineralDiscount" value="5" step="0.1">
          </fieldset>
        </div>
      </div>
      <!-- Battery Recycling Group -->
      <div class="group">
        <h3 class="group-title collapsed" onclick="toggleGroup(this)">Battery Recycling</h3>
        <div class="group-content">
          <fieldset data-tippy-content="Set battery recycling parameters.">
            <legend>Recycling Parameters</legend>
            <label for="scrapRate" data-tippy-content="Percentage of production scrap generated during manufacturing.">Production scrap rate (%):</label>
            <input type="number" id="scrapRate" value="5" step="1">
            <label for="collectionRate" data-tippy-content="Percentage of used batteries that are collected for recycling.">Collection rate (%):</label>
            <input type="number" id="collectionRate" value="60" step="1">
            <label for="recoveryRate" data-tippy-content="Percentage of minerals that can be recovered from collected batteries.">Recovery rate (%):</label>
            <input type="number" id="recoveryRate" value="80" step="1">
          </fieldset>
          <fieldset data-tippy-content="Set average battery lifetimes (years) per sector.">
            <legend>Battery Lifetimes</legend>
            <label for="lifetimeCars" data-tippy-content="Average lifetime (years) for car batteries.">Cars (years):</label>
            <input type="number" id="lifetimeCars" value="15" step="1">
            <label for="lifetimeLT" data-tippy-content="Average lifetime (years) for light truck batteries.">Light Trucks (years):</label>
            <input type="number" id="lifetimeLT" value="12" step="1">
            <label for="lifetimeHT" data-tippy-content="Average lifetime (years) for heavy truck batteries.">Heavy Trucks (years):</label>
            <input type="number" id="lifetimeHT" value="10" step="1">
            <label for="lifetimeSS" data-tippy-content="Average lifetime (years) for stationary storage batteries.">Stationary Storage (years):</label>
            <input type="number" id="lifetimeSS" value="20" step="1">
            <label for="lifetimeBuses" data-tippy-content="Average lifetime (years) for bus batteries.">Buses (years):</label>
            <input type="number" id="lifetimeBuses" value="12" step="1">
            <label for="lifetimeTTW" data-tippy-content="Average lifetime (years) for 2/3 wheeler batteries.">2/3 Wheelers (years):</label>
            <input type="number" id="lifetimeTTW" value="8" step="1">
            <label for="lifetimeTrains" data-tippy-content="Average lifetime (years) for train batteries.">Trains (years):</label>
            <input type="number" id="lifetimeTrains" value="20" step="1">
            <label for="lifetimeShips" data-tippy-content="Average lifetime (years) for ship batteries.">Ships (years):</label>
            <input type="number" id="lifetimeShips" value="20" step="1">
            <label for="lifetimeAirplanes" data-tippy-content="Average lifetime (years) for airplane batteries.">Airplanes (years):</label>
            <input type="number" id="lifetimeAirplanes" value="15" step="1">
          </fieldset>
        </div>
      </div>
    </div>
    <!-- Content: Chart controls and canvas -->
    <div id="content">
      <div id="chartControls">
        <label for="chartType">Chart type:</label>
        <select id="chartType">
          <option value="line">Battery demand | Line chart</option>
          <option value="stackedBar">Battery demand | Stacked bar chart</option>
          <option value="stacked100Bar">Battery demand | 100% stacked bar chart</option>
          <option value="mineral">Minerals | Mineral demand projections</option>
          <option value="mining">Minerals | Mineral mining demand</option>
          <option value="recycled">Minerals | Recycled minerals by mineral</option>
          <option value="oil">Energy | Displaced oil (mb/d)</option>
        </select>
        <button type="button" id="updateChartBtn">Update</button>
      </div>
      <div id="chartSection">
        <canvas id="chartCanvas"></canvas>
      </div>
    </div>
  </div>
  
  <footer>
    Created by <strong>Daan Walter</strong>, 2025
  </footer>
  
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/scale.css"/>
  <script>
    // Toggle group content display on click and update arrow.
    function toggleGroup(el) {
      const content = el.nextElementSibling;
      if (content.style.display === "none" || content.style.display === "") {
        content.style.display = "block";
        el.classList.remove("collapsed");
        el.classList.add("expanded");
      } else {
        content.style.display = "none";
        el.classList.remove("expanded");
        el.classList.add("collapsed");
      }
    }
    
    document.addEventListener("DOMContentLoaded", function() {
      // Ensure all group titles are collapsed by default.
      document.querySelectorAll('.group-title').forEach(el => {
        el.classList.add("collapsed");
        const content = el.nextElementSibling;
        content.style.display = "none";
      });
      tippy('[data-tippy-content]', {
        animation: 'scale',
        theme: 'light-border'
      });
    });
    
    // Set Chart.js default font family and size.
    Chart.defaults.font.family = 'Poppins, sans-serif';
    Chart.defaults.font.size = 15;
    
    function logistic(t, L, k, t0) {
      return L / (1 + Math.exp(-k * (t - t0)));
    }
    
    function netProduction(t, params, scrapRate) {
      return logistic(t, params.L, params.k, params.t0) * (1 - scrapRate);
    }
    
    function computeCumulative(years, sectors, scrapRate) {
      const cum = [];
      let total = 0;
      years.forEach(y => {
        let yearly = 0;
        Object.values(sectors).forEach(params => {
          yearly += netProduction(y, params, scrapRate);
        });
        total += yearly;
        cum.push(total);
      });
      return cum;
    }
    
    function discountFactor(cumProd, ref, mineralDiscount) {
      if (cumProd <= ref) return 1;
      const doublings = Math.log2(cumProd / ref);
      return Math.pow(1 - (mineralDiscount / 100), doublings);
    }
    
    const palette = {
      'Cars': "#13ce74",
      'Light Trucks': "#DC3912",
      'Heavy Trucks': "#FF9900",
      'Stationary Storage': "#109618",
      'Buses': "#990099",
      '2/3 Wheelers': "#0099C6",
      'Trains': "#DD4477",
      'Ships': "#66AA00",
      'Airplanes': "#B82E2E"
    };
    
    const mineralReq = {
      NMC: { lithium: 0.1, nickel: 0.5, manganese: 0.3, cobalt: 0.1 },
      LFP: { lithium: 0.08, iron: 0.8, phosphate: 0.3 },
      Sodium: { sodium: 0.2, lithium: 0.05, manganese: 0.2 }
    };
    
    const mineralPalette = {
      lithium: "#FF5733",
      nickel: "#33A1FF",
      manganese: "#FF33F6",
      cobalt: "#AA33FF",
      iron: "#33FF57",
      phosphate: "#FF8C00",
      sodium: "#FFD700"
    };
    
    const baselineOil = {
      "Cars": 20,
      "Light Trucks": 8,
      "Heavy Trucks": 8,
      "Buses": 4,
      "2/3 Wheelers": 3
    };
    
    let chart;
    
    function updateCharts() {
      const selectedType = document.getElementById('chartType').value;
      if (chart) { chart.destroy(); }
      if (selectedType === "mineral") {
        updateMineralChart();
      } else if (selectedType === "mining") {
        updateMiningChart();
      } else if (selectedType === "recycled") {
        updateRecycledChart();
      } else if (selectedType === "oil") {
        updateOilChart();
      } else {
        updateBatteryChart(selectedType);
      }
    }
    
    function updateBatteryChart(selectedType) {
      const startYear = parseInt(document.getElementById('startYear').value);
      const endYear = parseInt(document.getElementById('endYear').value);
      const years = [];
      for (let y = startYear; y <= endYear; y++) { years.push(y); }
      
      const sectors = {
        'Cars': { L: parseFloat(document.getElementById('carsL').value), k: parseFloat(document.getElementById('carsK').value), t0: parseInt(document.getElementById('carsT0').value) },
        'Light Trucks': { L: parseFloat(document.getElementById('ltL').value), k: parseFloat(document.getElementById('ltK').value), t0: parseInt(document.getElementById('ltT0').value) },
        'Heavy Trucks': { L: parseFloat(document.getElementById('htL').value), k: parseFloat(document.getElementById('htK').value), t0: parseInt(document.getElementById('htT0').value) },
        'Stationary Storage': { L: parseFloat(document.getElementById('ssL').value), k: parseFloat(document.getElementById('ssK').value), t0: parseInt(document.getElementById('ssT0').value) },
        'Buses': { L: parseFloat(document.getElementById('busesL').value), k: parseFloat(document.getElementById('busesK').value), t0: parseInt(document.getElementById('busesT0').value) },
        '2/3 Wheelers': { L: parseFloat(document.getElementById('ttwL').value), k: parseFloat(document.getElementById('ttwK').value), t0: parseInt(document.getElementById('ttwT0').value) },
        'Trains': { L: parseFloat(document.getElementById('trainsL').value), k: parseFloat(document.getElementById('trainsK').value), t0: parseInt(document.getElementById('trainsT0').value) },
        'Ships': { L: parseFloat(document.getElementById('shipsL').value), k: parseFloat(document.getElementById('shipsK').value), t0: parseInt(document.getElementById('shipsT0').value) },
        'Airplanes': { L: parseFloat(document.getElementById('planesL').value), k: parseFloat(document.getElementById('planesK').value), t0: parseInt(document.getElementById('planesT0').value) }
      };
      
      const timeDatasets = [];
      for (const [sector, params] of Object.entries(sectors)) {
        const data = years.map(year => logistic(year, params.L, params.k, params.t0));
        timeDatasets.push({
          label: sector,
          data: data,
          fill: false,
          tension: 0.3,
          borderColor: palette[sector],
          backgroundColor: palette[sector]
        });
      }
      
      let chartData = { labels: years, datasets: timeDatasets };
      let chartOptions = {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' },
          title: { display: true, text: 'Battery demand projections' }
        },
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'Demand (TWh/year)' } },
          x: { title: { display: true, text: 'Year' } }
        }
      };
      
      let chartTypeStr = "line";
      if (selectedType === "line") {
        chartTypeStr = "line";
      } else if (selectedType === "stackedBar") {
        chartTypeStr = "bar";
        chartOptions.scales.x.stacked = true;
        chartOptions.scales.y.stacked = true;
      } else if (selectedType === "stacked100Bar") {
        chartTypeStr = "bar";
        chartOptions.scales.x.stacked = true;
        chartOptions.scales.y.stacked = true;
        chartOptions.scales.y.title.text = "Percentage (%)";
        const pctBarDatasets = timeDatasets.map(() => []);
        years.forEach((year, j) => {
          const sum = timeDatasets.reduce((acc, ds) => acc + ds.data[j], 0);
          timeDatasets.forEach((ds, i) => {
            pctBarDatasets[i].push(sum ? (ds.data[j] / sum * 100) : 0);
          });
        });
        const newBarDatasets = timeDatasets.map((ds, i) => ({
          label: ds.label,
          data: pctBarDatasets[i],
          backgroundColor: ds.backgroundColor
        }));
        chartData = { labels: years, datasets: newBarDatasets };
      }
      
      const ctx = document.getElementById('chartCanvas').getContext('2d');
      chart = new Chart(ctx, { type: chartTypeStr, data: chartData, options: chartOptions });
    }
    
    function updateMineralChart() {
      const startYear = parseInt(document.getElementById('startYear').value);
      const endYear = parseInt(document.getElementById('endYear').value);
      const years = [];
      for (let y = startYear; y <= endYear; y++) { years.push(y); }
      
      const mix = (y) => {
        const fraction = (y - startYear) / (endYear - startYear);
        return {
          nmc: parseFloat(document.getElementById('nmcStart').value) + (parseFloat(document.getElementById('nmcEnd').value) - parseFloat(document.getElementById('nmcStart').value)) * fraction,
          lfp: parseFloat(document.getElementById('lfpStart').value) + (parseFloat(document.getElementById('lfpEnd').value) - parseFloat(document.getElementById('lfpStart').value)) * fraction,
          sodium: parseFloat(document.getElementById('sodiumStart').value) + (parseFloat(document.getElementById('sodiumEnd').value) - parseFloat(document.getElementById('sodiumStart').value)) * fraction
        };
      };
      
      const sectors = {
        'Cars': { L: parseFloat(document.getElementById('carsL').value), k: parseFloat(document.getElementById('carsK').value), t0: parseInt(document.getElementById('carsT0').value) },
        'Light Trucks': { L: parseFloat(document.getElementById('ltL').value), k: parseFloat(document.getElementById('ltK').value), t0: parseInt(document.getElementById('ltT0').value) },
        'Heavy Trucks': { L: parseFloat(document.getElementById('htL').value), k: parseFloat(document.getElementById('htK').value), t0: parseInt(document.getElementById('htT0').value) },
        'Stationary Storage': { L: parseFloat(document.getElementById('ssL').value), k: parseFloat(document.getElementById('ssK').value), t0: parseInt(document.getElementById('ssT0').value) },
        'Buses': { L: parseFloat(document.getElementById('busesL').value), k: parseFloat(document.getElementById('busesK').value), t0: parseInt(document.getElementById('busesT0').value) },
        '2/3 Wheelers': { L: parseFloat(document.getElementById('ttwL').value), k: parseFloat(document.getElementById('ttwK').value), t0: parseInt(document.getElementById('ttwT0').value) },
        'Trains': { L: parseFloat(document.getElementById('trainsL').value), k: parseFloat(document.getElementById('trainsK').value), t0: parseInt(document.getElementById('trainsT0').value) },
        'Ships': { L: parseFloat(document.getElementById('shipsL').value), k: parseFloat(document.getElementById('shipsK').value), t0: parseInt(document.getElementById('shipsT0').value) },
        'Airplanes': { L: parseFloat(document.getElementById('planesL').value), k: parseFloat(document.getElementById('planesK').value), t0: parseInt(document.getElementById('planesT0').value) }
      };
      
      const scrapRate = parseFloat(document.getElementById('scrapRate').value) / 100;
      const cumProd = computeCumulative(years, sectors, scrapRate);
      const ref = cumProd[0] || 1e-9;
      const mineralDiscount = parseFloat(document.getElementById('mineralDiscount').value);
      
      const minerals = ["lithium", "nickel", "manganese", "cobalt", "iron", "phosphate", "sodium"];
      let gross = {};
      minerals.forEach(m => { gross[m] = []; });
      
      years.forEach((y, idx) => {
        const currentMix = mix(y);
        function req(m) {
          return (currentMix.nmc/100 * (mineralReq.NMC[m]||0)) +
                 (currentMix.lfp/100 * (mineralReq.LFP[m]||0)) +
                 (currentMix.sodium/100 * (mineralReq.Sodium[m]||0));
        }
        const discount = discountFactor(cumProd[idx], ref, mineralDiscount);
        let sumForYear = {};
        minerals.forEach(m => { sumForYear[m] = 0; });
        Object.values(sectors).forEach(params => {
          const prod = logistic(y, params.L, params.k, params.t0);
          const netProd = prod * (1 - scrapRate);
          minerals.forEach(m => {
            sumForYear[m] += netProd * 1e9 * req(m) * discount;
          });
        });
        minerals.forEach(m => {
          gross[m].push(sumForYear[m] / 1e9);
        });
      });
      
      const datasets = minerals.map(m => ({
        label: m.charAt(0).toUpperCase() + m.slice(1),
        data: gross[m],
        borderColor: mineralPalette[m],
        fill: false,
        tension: 0.3
      }));
      
      const chartData = { labels: years, datasets: datasets };
      const chartOptions = {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' },
          title: { display: true, text: 'Mineral demand projections (gross, million tons)' }
        },
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'Demand (million tons)' } },
          x: { title: { display: true, text: 'Year' } }
        }
      };
      
      const ctx = document.getElementById('chartCanvas').getContext('2d');
      chart = new Chart(ctx, { type: 'line', data: chartData, options: chartOptions });
    }
    
    function updateRecycledChart() {
      const startYear = parseInt(document.getElementById('startYear').value);
      const endYear = parseInt(document.getElementById('endYear').value);
      const years = [];
      for (let y = startYear; y <= endYear; y++) { years.push(y); }
      
      const scrapRate = parseFloat(document.getElementById('scrapRate').value) / 100;
      const collectionRate = parseFloat(document.getElementById('collectionRate').value) / 100;
      const recoveryRate = parseFloat(document.getElementById('recoveryRate').value) / 100;
      const mineralDiscount = parseFloat(document.getElementById('mineralDiscount').value);
      
      const sectors = {
        'Cars': { L: parseFloat(document.getElementById('carsL').value), k: parseFloat(document.getElementById('carsK').value), t0: parseInt(document.getElementById('carsT0').value), lifetime: parseInt(document.getElementById('lifetimeCars').value) },
        'Light Trucks': { L: parseFloat(document.getElementById('ltL').value), k: parseFloat(document.getElementById('ltK').value), t0: parseInt(document.getElementById('ltT0').value), lifetime: parseInt(document.getElementById('lifetimeLT').value) },
        'Heavy Trucks': { L: parseFloat(document.getElementById('htL').value), k: parseFloat(document.getElementById('htK').value), t0: parseInt(document.getElementById('htT0').value), lifetime: parseInt(document.getElementById('lifetimeHT').value) },
        'Stationary Storage': { L: parseFloat(document.getElementById('ssL').value), k: parseFloat(document.getElementById('ssK').value), t0: parseInt(document.getElementById('ssT0').value), lifetime: parseInt(document.getElementById('lifetimeSS').value) },
        'Buses': { L: parseFloat(document.getElementById('busesL').value), k: parseFloat(document.getElementById('busesK').value), t0: parseInt(document.getElementById('busesT0').value), lifetime: parseInt(document.getElementById('lifetimeBuses').value) },
        '2/3 Wheelers': { L: parseFloat(document.getElementById('ttwL').value), k: parseFloat(document.getElementById('ttwK').value), t0: parseInt(document.getElementById('ttwT0').value), lifetime: parseInt(document.getElementById('lifetimeTTW').value) },
        'Trains': { L: parseFloat(document.getElementById('trainsL').value), k: parseFloat(document.getElementById('trainsK').value), t0: parseInt(document.getElementById('trainsT0').value), lifetime: parseInt(document.getElementById('lifetimeTrains').value) },
        'Ships': { L: parseFloat(document.getElementById('shipsL').value), k: parseFloat(document.getElementById('shipsK').value), t0: parseInt(document.getElementById('shipsT0').value), lifetime: parseInt(document.getElementById('lifetimeShips').value) },
        'Airplanes': { L: parseFloat(document.getElementById('planesL').value), k: parseFloat(document.getElementById('planesK').value), t0: parseInt(document.getElementById('planesT0').value), lifetime: parseInt(document.getElementById('lifetimeAirplanes').value) }
      };
      
      const minerals = ["lithium", "nickel", "manganese", "cobalt", "iron", "phosphate", "sodium"];
      let recycled = {};
      minerals.forEach(m => { recycled[m] = Array(years.length).fill(0); });
      
      const cumProd = computeCumulative(years, sectors, scrapRate);
      const ref = cumProd[0] || 1e-9;
      
      years.forEach((currentYear, idx) => {
        Object.values(sectors).forEach(params => {
          for (let t = startYear; t <= currentYear; t++){
            if (t + params.lifetime === currentYear) {
              const currentMix = mixForYear(t);
              function req(m) {
                return (currentMix.nmc/100 * (mineralReq.NMC[m]||0)) +
                       (currentMix.lfp/100 * (mineralReq.LFP[m]||0)) +
                       (currentMix.sodium/100 * (mineralReq.Sodium[m]||0));
              }
              const prod_t = logistic(t, params.L, params.k, params.t0);
              const netProd_t = prod_t * (1 - scrapRate);
              const tIndex = years.indexOf(t);
              const discount_t = discountFactor(cumProd[tIndex], ref, mineralDiscount);
              minerals.forEach(m => {
                recycled[m][idx] += netProd_t * 1e9 * collectionRate * recoveryRate * req(m) * discount_t;
              });
            }
          }
        });
      });
      
      let datasets = [];
      minerals.forEach(m => {
        let annual = recycled[m].map(val => val / 1e9);
        let cumulative = [];
        annual.reduce((acc, val) => {
          acc += val;
          cumulative.push(acc);
          return acc;
        }, 0);
        datasets.push({
          label: m.charAt(0).toUpperCase() + m.slice(1),
          data: cumulative,
          borderColor: mineralPalette[m],
          fill: false,
          tension: 0.3
        });
      });
      
      const chartData = { labels: years, datasets: datasets };
      const chartOptions = {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' },
          title: { display: true, text: 'Cumulative recycled minerals by mineral (million tons)' }
        },
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'Cumulative recycled (million tons)' } },
          x: { title: { display: true, text: 'Year' } }
        }
      };
      
      const ctx = document.getElementById('chartCanvas').getContext('2d');
      chart = new Chart(ctx, { type: 'line', data: chartData, options: chartOptions });
    }
    
    function updateMiningChart() {
      const startYear = parseInt(document.getElementById('startYear').value);
      const endYear = parseInt(document.getElementById('endYear').value);
      const years = [];
      for (let y = startYear; y <= endYear; y++) { years.push(y); }
      
      const scrapRate = parseFloat(document.getElementById('scrapRate').value) / 100;
      const collectionRate = parseFloat(document.getElementById('collectionRate').value) / 100;
      const recoveryRate = parseFloat(document.getElementById('recoveryRate').value) / 100;
      const mineralDiscount = parseFloat(document.getElementById('mineralDiscount').value);
      
      const sectors = {
        'Cars': { L: parseFloat(document.getElementById('carsL').value), k: parseFloat(document.getElementById('carsK').value), t0: parseInt(document.getElementById('carsT0').value), lifetime: parseInt(document.getElementById('lifetimeCars').value) },
        'Light Trucks': { L: parseFloat(document.getElementById('ltL').value), k: parseFloat(document.getElementById('ltK').value), t0: parseInt(document.getElementById('ltT0').value), lifetime: parseInt(document.getElementById('lifetimeLT').value) },
        'Heavy Trucks': { L: parseFloat(document.getElementById('htL').value), k: parseFloat(document.getElementById('htK').value), t0: parseInt(document.getElementById('htT0').value), lifetime: parseInt(document.getElementById('lifetimeHT').value) },
        'Stationary Storage': { L: parseFloat(document.getElementById('ssL').value), k: parseFloat(document.getElementById('ssK').value), t0: parseInt(document.getElementById('ssT0').value), lifetime: parseInt(document.getElementById('lifetimeSS').value) },
        'Buses': { L: parseFloat(document.getElementById('busesL').value), k: parseFloat(document.getElementById('busesK').value), t0: parseInt(document.getElementById('busesT0').value), lifetime: parseInt(document.getElementById('lifetimeBuses').value) },
        '2/3 Wheelers': { L: parseFloat(document.getElementById('ttwL').value), k: parseFloat(document.getElementById('ttwK').value), t0: parseInt(document.getElementById('ttwT0').value), lifetime: parseInt(document.getElementById('lifetimeTTW').value) },
        'Trains': { L: parseFloat(document.getElementById('trainsL').value), k: parseFloat(document.getElementById('trainsK').value), t0: parseInt(document.getElementById('trainsT0').value), lifetime: parseInt(document.getElementById('lifetimeTrains').value) },
        'Ships': { L: parseFloat(document.getElementById('shipsL').value), k: parseFloat(document.getElementById('shipsK').value), t0: parseInt(document.getElementById('shipsT0').value), lifetime: parseInt(document.getElementById('lifetimeShips').value) },
        'Airplanes': { L: parseFloat(document.getElementById('planesL').value), k: parseFloat(document.getElementById('planesK').value), t0: parseInt(document.getElementById('planesT0').value), lifetime: parseInt(document.getElementById('lifetimeAirplanes').value) }
      };
      
      const minerals = ["lithium", "nickel", "manganese", "cobalt", "iron", "phosphate", "sodium"];
      let newInput = {};
      let recycled = {};
      minerals.forEach(m => {
        newInput[m] = Array(years.length).fill(0);
        recycled[m] = Array(years.length).fill(0);
      });
      
      const cumProd = computeCumulative(years, sectors, scrapRate);
      const ref = cumProd[0] || 1e-9;
      
      years.forEach((y, idx) => {
        const currentMix = mixForYear(y);
        function req(m) {
          return (currentMix.nmc/100 * (mineralReq.NMC[m]||0)) +
                 (currentMix.lfp/100 * (mineralReq.LFP[m]||0)) +
                 (currentMix.sodium/100 * (mineralReq.Sodium[m]||0));
        }
        const discount = discountFactor(cumProd[idx], ref, mineralDiscount);
        Object.values(sectors).forEach(params => {
          const prod = logistic(y, params.L, params.k, params.t0);
          const netProd = prod * (1 - scrapRate);
          minerals.forEach(m => {
            newInput[m][idx] += netProd * 1e9 * req(m) * discount;
          });
        });
      });
      
      years.forEach((currentYear, idx) => {
        Object.values(sectors).forEach(params => {
          for (let t = startYear; t <= currentYear; t++){
            if (t + params.lifetime === currentYear) {
              const currentMix = mixForYear(t);
              function req(m) {
                return (currentMix.nmc/100 * (mineralReq.NMC[m]||0)) +
                       (currentMix.lfp/100 * (mineralReq.LFP[m]||0)) +
                       (currentMix.sodium/100 * (mineralReq.Sodium[m]||0));
              }
              const prod_t = logistic(t, params.L, params.k, params.t0);
              const netProd_t = prod_t * (1 - scrapRate);
              const tIndex = years.indexOf(t);
              const discount_t = discountFactor(cumProd[tIndex], ref, mineralDiscount);
              minerals.forEach(m => {
                recycled[m][idx] += netProd_t * 1e9 * collectionRate * recoveryRate * req(m) * discount_t;
              });
            }
          }
        });
      });
      
      let netMining = {};
      minerals.forEach(m => {
        netMining[m] = years.map((_, idx) => {
          let net = (newInput[m][idx] - recycled[m][idx]) / 1e9;
          return net < 0 ? 0 : net;
        });
      });
      
      const datasets = minerals.map(m => ({
        label: m.charAt(0).toUpperCase() + m.slice(1),
        data: netMining[m],
        borderColor: mineralPalette[m],
        fill: false,
        tension: 0.3
      }));
      
      const chartData = { labels: years, datasets: datasets };
      const chartOptions = {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' },
          title: { display: true, text: 'Mineral mining demand (net, million tons)' }
        },
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'Demand (million tons)' } },
          x: { title: { display: true, text: 'Year' } }
        }
      };
      
      const ctx = document.getElementById('chartCanvas').getContext('2d');
      chart = new Chart(ctx, { type: 'line', data: chartData, options: chartOptions });
    }
    
    function evStockFraction(year, params, startYear) {
      let sum = 0;
      let count = 0;
      const firstSale = Math.max(startYear, year - params.lifetime + 1);
      for (let saleYear = firstSale; saleYear <= year; saleYear++) {
        let frac = logistic(saleYear, params.L, params.k, params.t0) / params.L;
        if (frac > 1) { frac = 1; }
        sum += frac;
        count++;
      }
      return count ? sum / count : 0;
    }
    
    function updateOilChart() {
      const startYear = parseInt(document.getElementById('startYear').value);
      const endYear = parseInt(document.getElementById('endYear').value);
      const years = [];
      for (let y = startYear; y <= endYear; y++) { years.push(y); }
      
      const sectors = {
        'Cars': { L: parseFloat(document.getElementById('carsL').value), k: parseFloat(document.getElementById('carsK').value), t0: parseInt(document.getElementById('carsT0').value), lifetime: parseInt(document.getElementById('lifetimeCars').value) },
        'Light Trucks': { L: parseFloat(document.getElementById('ltL').value), k: parseFloat(document.getElementById('ltK').value), t0: parseInt(document.getElementById('ltT0').value), lifetime: parseInt(document.getElementById('lifetimeLT').value) },
        'Heavy Trucks': { L: parseFloat(document.getElementById('htL').value), k: parseFloat(document.getElementById('htK').value), t0: parseInt(document.getElementById('htT0').value), lifetime: parseInt(document.getElementById('lifetimeHT').value) },
        'Buses': { L: parseFloat(document.getElementById('busesL').value), k: parseFloat(document.getElementById('busesK').value), t0: parseInt(document.getElementById('busesT0').value), lifetime: parseInt(document.getElementById('lifetimeBuses').value) },
        '2/3 Wheelers': { L: parseFloat(document.getElementById('ttwL').value), k: parseFloat(document.getElementById('ttwK').value), t0: parseInt(document.getElementById('ttwT0').value), lifetime: parseInt(document.getElementById('lifetimeTTW').value) }
      };
      
      let displaced = {};
      Object.keys(sectors).forEach(sec => {
        const params = sectors[sec];
        displaced[sec] = years.map(year => {
          const evFraction = evStockFraction(year, params, startYear);
          return baselineOil[sec] * evFraction;
        });
      });
      
      const datasets = Object.keys(sectors).map(sec => ({
        label: sec,
        data: displaced[sec],
        backgroundColor: palette[sec]
      }));
      
      const chartData = { labels: years, datasets: datasets };
      const chartOptions = {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' },
          title: { display: true, text: 'Displaced oil by EV adoption (mb/d)' }
        },
        scales: {
          x: { 
            stacked: true,
            title: { display: true, text: 'Year' }
          },
          y: { 
            beginAtZero: true,
            stacked: true,
            title: { display: true, text: 'Displaced oil (mb/d)' }
          }
        }
      };
      
      const ctx = document.getElementById('chartCanvas').getContext('2d');
      chart = new Chart(ctx, { type: 'bar', data: chartData, options: chartOptions });
    }
    
    function mixForYear(y) {
      const startYear = parseInt(document.getElementById('startYear').value);
      const endYear = parseInt(document.getElementById('endYear').value);
      const fraction = (y - startYear) / (endYear - startYear);
      return {
        nmc: parseFloat(document.getElementById('nmcStart').value) + (parseFloat(document.getElementById('nmcEnd').value) - parseFloat(document.getElementById('nmcStart').value)) * fraction,
        lfp: parseFloat(document.getElementById('lfpStart').value) + (parseFloat(document.getElementById('lfpEnd').value) - parseFloat(document.getElementById('lfpStart').value)) * fraction,
        sodium: parseFloat(document.getElementById('sodiumStart').value) + (parseFloat(document.getElementById('sodiumEnd').value) - parseFloat(document.getElementById('sodiumStart').value)) * fraction
      };
    }
    
    document.getElementById('updateChartBtn').addEventListener('click', updateCharts);
    updateCharts();
  </script>
</body>
</html>


